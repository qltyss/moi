<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="./css/bootstrap.min.css" rel="stylesheet">

    <title>Document</title>
    <link rel="stylesheet" href="./css/nlp.css">

    
</head>
<body>
    <div class="container-fluid">
        

<!-- The model container -->
<div id="myModal" class="modal " class="modal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">

    <div class="modal-dialog  modal-dialog-centered modal-xl" >
        <div class="modal-content" style="background:rgba(42, 52, 76)" >
          <div class="modal-header">
            <h5 class="modal-title text-white" id="exampleModalLabel">IP Panel</h5>
            
          </div>
          <div class="modal-body">
            <!-- <input type="text" id="ip" placeholder="Enter WebSocket IP...."> -->
            <input type="text" class="form-control"  id="ip" placeholder="Enter WebSocket IP....">
            <p class="error text-danger fw-bold pt-4" id="errorPanel" >Erorr is Showing Here....</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="closeModel">Close</button>
            <button type="button" class="btn btn-primary" id="connectIP">Connect</button>
          </div>
        </div>
      </div>
</div>


        <div class="row d-flex justify-content-center" style="position: relative;">



                <div class="col-xl-12 col-md-12 col-lg-12 col-sm-12" id="iconDiv" style="padding-bottom:6rem;">
                    <div class="row p-3 ">
                        <div class="col-xl-6 col-lg-6 col-md-6 col-sm-12 pt-2" id="humanshowMessages" >
                            <img src="./img/qssplogo.png" alt="" class=" nointerpolation w-15">
                        </div>
                        <div class="col-xl-6 col-lg-6 col-md-6 col-sm-12 pt-3 text-end " >
                            <img src="./img/qsspp.png" alt="" class="w-65 nointerpolation" id="openIpPanel">
                        </div>
                        
                    </div>
                </div>




                <div class="col-xl-11 col-md-11 col-lg-11 col-sm-12 " id="messageDiv">
                    <div class="row ">
                        
                        
                        <div class="col-xl-12 col-md-12 col-lg-12 col-sm-12 p-5 txtFormat" id="">
                           
                            <div id="centeredText" class="">Sara - the first Saudi humanoid robot</div>


                            <!-- <p class="ptxt border"><span class="text-white">$</span> <span class="roletxt">Person</span> <span class="greater"> > </span>  gimme frontend dev</p>

                            <p class="rtxt"><span class="text-white">$</span>  <span class="roletxt">Robot</span> <span class="greater"> > </span>  gimme <span class="greentxt">frontend</span>  dev <span class="cursor-blink"></span></p> -->

                            <div class="col-md-12 ">
                                <div id="messageContainer" class="fontSize "></div>
                            </div>
                        </div>
                    </div>
                </div>

        </div>
    </div>
</body>
<script src="./js/jquery.min.js"></script>

<script>

    
    $(document).ready(function() {

        var ongoingHumanMessageId = null;
        var ongoingRobotMessageId = null;
        var humaninterval = null; 
        var robotinterval = null;

        function showSystemMessage(data) {
            var spanClass = (data.role === 'system') ? 'human-text' : 'robot-text';

            // Create a unique ID for the message element
            var messageId = 'system-message-' + data.id;

            // Check if a message with the current ID already exists
            var shexistingMessage = $('#' + messageId);

            // Remove the 'cursor-blink' class from existing messages
            shexistingMessage.find('.cursor-blink').removeClass('cursor-blink');

            if (shexistingMessage.length === 0) {
                hflag = true;

                // Create the message element with the unique ID
                var shumanmessageElement = $('<p>').attr('id', messageId).addClass('stxt nullm my-4');

                // var roleSpan = $('<span>').addClass('greater').text('$ ');
                // var roletxtSpan = $('<span>').addClass('roletxt').text(data.role + ' ');
                // var greaterSpan = $('<span>').addClass('greater').text(' > ');
                var cursorSpan = $('<span>').addClass('cursor-blink');

                shumanmessageElement.append(data.txt, cursorSpan);
                $('#messageContainer').append(shumanmessageElement);
            } else {
                // var uroleSpan = $('<span>').addClass('greater').text('$ ');
                // var uroletxtSpan = $('<span>').addClass('roletxt').text(data.role + ' ');
                // var ugreaterSpan = $('<span>').addClass('greater').text(' > ');
                var cursorSpan = $('<span>').addClass('cursor-blink');

                shexistingMessage.empty().append(ata.txt, cursorSpan);
            }
        }

        function showHumanMessage(data) {
            var spanClass = (data.role === 'human') ? 'human-text' : 'robot-text';

            // Create a unique ID for the message element
            var messageId = 'human-message-' + data.id;

            // Check if a message with the current ID already exists
            var hexistingMessage = $('#' + messageId);

            // Remove the 'cursor-blink' class from existing messages
            hexistingMessage.find('.cursor-blink').removeClass('cursor-blink');

            if (hexistingMessage.length === 0) {
                hflag = true;

                // Create the message element with the unique ID
                var humanmessageElement = $('<p>').attr('id', messageId).addClass('ptxt nullm mt-4');

                var roleSpan = $('<span>').addClass('greater').text('$ ');
                var roletxtSpan = $('<span>').addClass('roletxt').text(data.role + ' ');
                var greaterSpan = $('<span>').addClass('greater').text(' > ');
                var cursorSpan = $('<span>').addClass('cursor-blink');

                humanmessageElement.append(roleSpan, roletxtSpan, greaterSpan, data.txt, cursorSpan);
                $('#messageContainer').append(humanmessageElement);
            } else {
                var uroleSpan = $('<span>').addClass('greater').text('$ ');
                var uroletxtSpan = $('<span>').addClass('roletxt').text(data.role + ' ');
                var ugreaterSpan = $('<span>').addClass('greater').text(' > ');
                var cursorSpan = $('<span>').addClass('cursor-blink');

                hexistingMessage.empty().append(uroleSpan, uroletxtSpan, ugreaterSpan, data.txt, cursorSpan);
            }
        }

       
        function showRobotMessage(message) {
                var spanClass = (message.role === 'human') ? 'human-text' : 'robot-text';

                // Check if a message with the current ID already exists
                var existingMessage = $('#robot-message-' + message.id);

                if (existingMessage.length === 0) {
                    // If the message is new, create a new message element
                    var robotMessageElement = $('<p>').addClass('rtxt nullm');

                    // Create spans for the different parts of the message format
                    var roleSpan = $('<span>').addClass('greater').text('$ ');
                    var roletxtSpan = $('<span>').addClass('roletxt').text(message.role + ' ');
                    var greaterSpan = $('<span>').addClass('greater').text(' > ');
                        var rcursorSpan = $('<span>').addClass('cursor-blink');
                    // Iterate over each character in the message text
                    for (var i = 0; i < message.txt.length; i++) {
                        var char = message.txt[i];

                        // Check if the current character is a space
                        if (char === ' ') {
                            robotMessageElement.append(' '); // Preserve space
                        } else {
                            var charSpan = $('<span>').text(char);

                            // Check if the current character should be red (based on green value)
                            if (message.green && i < message.green) {
                                charSpan.addClass('green-text');
                            }

                            // Append the character span to the message content
                            robotMessageElement.append(charSpan);
                        }
                    }

                    // Append all the spans to the new message element
                    robotMessageElement.prepend(greaterSpan).prepend(roletxtSpan).prepend(roleSpan);
                    robotMessageElement.append(rcursorSpan);
                    // Set the ID attribute
                    robotMessageElement.attr('id', 'robot-message-' + message.id);

                    // Append the new message element to the container
                    $('#messageContainer').append(robotMessageElement);
                } else {
                    // If the message is not new, clear the existing message content and update it
                    existingMessage.empty();

                    // Create updated spans for the different parts of the message format
                    var updateDollerSpan = $('<span>').addClass('greater').text('$ ');
                    var updatedRoleSpan = $('<span>').addClass('roletxt').text(message.role + ' ');
                    var updatedGreaterSpan = $('<span>').addClass('greater').text(' > ');
                        var urcursorSpan = $('<span>').addClass('cursor-blink');
                    // Iterate over each character in the updated message text
                    for (var i = 0; i < message.txt.length; i++) {
                        var char = message.txt[i];

                        // Check if the current character is a space
                        if (char === ' ') {
                            existingMessage.append(' '); // Preserve space
                        } else {
                            var charSpan = $('<span>').text(char);

                            // Check if the current character should be red (based on green value)
                            if (message.green && i < message.green) {
                                charSpan.addClass('green-text');
                            }

                            // Append the character span to the updated message content
                            existingMessage.append(charSpan);
                        }
                    }

                    // Append the updated spans to the existing message element
                    existingMessage.prepend(updatedGreaterSpan).prepend(updatedRoleSpan).prepend(updateDollerSpan);
                    existingMessage.append(urcursorSpan);
                    // existingMessage.prepend(updatedGreaterSpan).prepend(updateDollerSpan).prepend(updatedRoleSpan);
                }
            }

 

    function scrollToBottom() {
        var messageDiv = $('#messageDiv');
        messageDiv.scrollTop(messageDiv[0].scrollHeight);
    }

        $("#openIpPanel").on("click", function () {
                 $("#myModal").show();
        });

    // Function to close the model
    $("#closeModel").on("click", function () {
        $("#myModal").hide();
    });



       

// websocket connection
// Declare the socket variable in the outer scope
let socket;

// websocket connection
// Get WebSocket URL from localStorage or use a default value
const savedWebSocketURL = localStorage.getItem('webSockIP');

// Check if the WebSocket URL is valid
if (savedWebSocketURL) {
    // Create WebSocket connection using the URL
    socket = new WebSocket(savedWebSocketURL);

    // Event listener for successful connection
    socket.addEventListener('open', (event) => {
        console.log('WebSocket connection established:', event);
    });

    // Event listener for connection errors
    socket.addEventListener('error', (event) => {
        console.error('WebSocket connection error:', event);
    });

    // Event listener for incoming messages
    socket.addEventListener('message', (event) => {
        
        try {
            const data = JSON.parse(event.data);
            if (data && data.role) {
                console.log('Received JSON data:', data);

                // Check the source and call the appropriate function
                if (data.role === 'robot') {
                    $('.cursor-blink').removeClass('cursor-blink');
                    showRobotMessage(data);
                    scrollToBottom();
                } else if (data.role === 'human') {
                    $('.cursor-blink').removeClass('cursor-blink');
                    showHumanMessage(data);
                    scrollToBottom();
                } else if (data.role === 'system') {
                    
                    $('.cursor-blink').removeClass('cursor-blink');
                    showSystemMessage(data);
                    scrollToBottom();
                }
            } else {
                console.error('Invalid JSON data:', event.data);
            }
        } catch (error) {
            console.error('Error parsing JSON:', error.message);
        }
    });

} else {
    console.error('WebSocket URL is null or undefined. Please provide a valid URL.');
}

$("#connectIP").on("click", function () {
    const inputValue = $("#ip").val();

    if (inputValue) {
        // Save the new WebSocket URL to localStorage
        localStorage.setItem('webSockIP', 'ws://' + inputValue);

        // Check if there is an existing WebSocket connection
        if (socket && socket.readyState === WebSocket.OPEN) {
            // Close the current WebSocket connection
            try {
                socket.close();
            } catch (error) {
                console.error('Error closing WebSocket:', error.message);
                $("#errorPanel").text("");
                $("#errorPanel").text("Error closing WebSocket");
            }
        }
        var url = localStorage.getItem('webSockIP')
        // Create a new WebSocket connection with the updated URL
        const newSocket = new WebSocket(url);

        // Event handler for successful connection
        newSocket.addEventListener('open', (event) => {
            console.log('WebSocket connection established:', event);
            $("#myModal").hide();
        });

        // Event handler for WebSocket close
        newSocket.addEventListener('close', (event) => {
            if (event.wasClean) {
                console.log(`WebSocket closed cleanly, code=${event.code}, reason=${event.reason}`);
                
            } else {
                console.error(`WebSocket connection died`);
                $("#errorPanel").text("");
                $("#errorPanel").text("Error :WebSocket connection died");
            }
        });

        // Event handler for WebSocket errors
        newSocket.addEventListener('error', (error) => {
            console.error('WebSocket Error:', error);
            $("#errorPanel").text("");
            $("#errorPanel").text('WebSocket Error:', error);
        });

        // Update the existing 'socket' variable with the new connection
        socket = newSocket;
        
        // Rest of your logic for handling the new connection..
        $("#messageContainer").empty();
        socket.addEventListener('message', (event) => {
        try {
            const data = JSON.parse(event.data);
            if (data && data.role) {
                console.log('Received JSON data:', data);

                // Check the source and call the appropriate function
                if (data.role === 'robot') {
                    $('.cursor-blink').removeClass('cursor-blink');
                    showRobotMessage(data);
                    scrollToBottom();
                } else if (data.role === 'human') {
                    consolel.log("human")
                    $('.cursor-blink').removeClass('cursor-blink');
                    showHumanMessage(data);
                    scrollToBottom();
                } else if (data.role === 'system') {
                    
                    $('.cursor-blink').removeClass('cursor-blink');
                    showSystemMessage(data);
                    scrollToBottom();
                }
            } else {
                console.error('Invalid JSON data:', event.data);
            }
        } catch (error) {
            console.error('Error parsing JSON:', error.message);
        }
    });
    } else {
        alert('Please enter a value before saving.');
    }
});




    }); 
</script>
</html>